<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>controllers/menu.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Attachment_Controller.html">Attachment_Controller</a><ul class='methods'><li data-type='method'><a href="Attachment_Controller.html#getAttachment">getAttachment</a></li><li data-type='method'><a href="Attachment_Controller.html#getAttachmentUrl">getAttachmentUrl</a></li></ul></li><li><a href="Bot_Controller.html">Bot_Controller</a><ul class='methods'><li data-type='method'><a href="Bot_Controller.html#clearUservars">clearUservars</a></li><li data-type='method'><a href="Bot_Controller.html#freezeUservars">freezeUservars</a></li><li data-type='method'><a href="Bot_Controller.html#getArray">getArray</a></li><li data-type='method'><a href="Bot_Controller.html#getSubstitution">getSubstitution</a></li><li data-type='method'><a href="Bot_Controller.html#getUserTopicTriggers">getUserTopicTriggers</a></li><li data-type='method'><a href="Bot_Controller.html#getUservar">getUservar</a></li><li data-type='method'><a href="Bot_Controller.html#getUservars">getUservars</a></li><li data-type='method'><a href="Bot_Controller.html#getVariable">getVariable</a></li><li data-type='method'><a href="Bot_Controller.html#initialMatch">initialMatch</a></li><li data-type='method'><a href="Bot_Controller.html#lastMatch">lastMatch</a></li><li data-type='method'><a href="Bot_Controller.html#processEvent">processEvent</a></li><li data-type='method'><a href="Bot_Controller.html#setArray">setArray</a></li><li data-type='method'><a href="Bot_Controller.html#setEntities">setEntities</a></li><li data-type='method'><a href="Bot_Controller.html#setGlobal">setGlobal</a></li><li data-type='method'><a href="Bot_Controller.html#setHandler">setHandler</a></li><li data-type='method'><a href="Bot_Controller.html#setPerson">setPerson</a></li><li data-type='method'><a href="Bot_Controller.html#setSubroutine">setSubroutine</a></li><li data-type='method'><a href="Bot_Controller.html#setSubstitution">setSubstitution</a></li><li data-type='method'><a href="Bot_Controller.html#setUservar">setUservar</a></li><li data-type='method'><a href="Bot_Controller.html#setUservars">setUservars</a></li><li data-type='method'><a href="Bot_Controller.html#setVariable">setVariable</a></li><li data-type='method'><a href="Bot_Controller.html#thawUservars">thawUservars</a></li></ul></li><li><a href="Facebook_Controller.html">Facebook_Controller</a><ul class='methods'><li data-type='method'><a href="Facebook_Controller.html#deleteMessengerProfile">deleteMessengerProfile</a></li><li data-type='method'><a href="Facebook_Controller.html#domainWhitelisting">domainWhitelisting</a></li><li data-type='method'><a href="Facebook_Controller.html#doSubscribeRequest">doSubscribeRequest</a></li><li data-type='method'><a href="Facebook_Controller.html#facebookLogin">facebookLogin</a></li><li data-type='method'><a href="Facebook_Controller.html#getFacebookMessage">getFacebookMessage</a></li><li data-type='method'><a href="Facebook_Controller.html#getFacebookTemplate">getFacebookTemplate</a></li><li data-type='method'><a href="Facebook_Controller.html#getFacebookToken">getFacebookToken</a></li><li data-type='method'><a href="Facebook_Controller.html#getFacebookUserData">getFacebookUserData</a></li><li data-type='method'><a href="Facebook_Controller.html#getFacebookUserDataByCode">getFacebookUserDataByCode</a></li><li data-type='method'><a href="Facebook_Controller.html#getMessengerProfile">getMessengerProfile</a></li><li data-type='method'><a href="Facebook_Controller.html#messengerEvent">messengerEvent</a></li><li data-type='method'><a href="Facebook_Controller.html#requestUserData">requestUserData</a></li><li data-type='method'><a href="Facebook_Controller.html#sendAction">sendAction</a></li><li data-type='method'><a href="Facebook_Controller.html#sendMessage">sendMessage</a></li><li data-type='method'><a href="Facebook_Controller.html#setGreetingText">setGreetingText</a></li><li data-type='method'><a href="Facebook_Controller.html#setMessengerProfile">setMessengerProfile</a></li><li data-type='method'><a href="Facebook_Controller.html#setPersistentMenu">setPersistentMenu</a></li><li data-type='method'><a href="Facebook_Controller.html#setStartButton">setStartButton</a></li></ul></li><li><a href="Menu_Controller.html">Menu_Controller</a><ul class='methods'><li data-type='method'><a href="Menu_Controller.html#getFacebookButtons">getFacebookButtons</a></li><li data-type='method'><a href="Menu_Controller.html#getFacebookMenu">getFacebookMenu</a></li><li data-type='method'><a href="Menu_Controller.html#getMenu">getMenu</a></li></ul></li><li><a href="NGINB.html">NGINB</a><ul class='methods'><li data-type='method'><a href="NGINB.html#addEventListener">addEventListener</a></li><li data-type='method'><a href="NGINB.html#configure">configure</a></li><li data-type='method'><a href="NGINB.html#dispatchDirectMessage">dispatchDirectMessage</a></li><li data-type='method'><a href="NGINB.html#dispatchEvent">dispatchEvent</a></li><li data-type='method'><a href="NGINB.html#getBotController">getBotController</a></li><li data-type='method'><a href="NGINB.html#getBotResponse">getBotResponse</a></li><li data-type='method'><a href="NGINB.html#getFacebookController">getFacebookController</a></li><li data-type='method'><a href="NGINB.html#getMenuController">getMenuController</a></li><li data-type='method'><a href="NGINB.html#getPageController">getPageController</a></li><li data-type='method'><a href="NGINB.html#getUserController">getUserController</a></li><li data-type='method'><a href="NGINB.html#sendMessageEvent">sendMessageEvent</a></li><li data-type='method'><a href="NGINB.html#setEntities">setEntities</a></li></ul></li><li><a href="Page_Controller.html">Page_Controller</a><ul class='methods'><li data-type='method'><a href="Page_Controller.html#getFacebookPageByLanguage">getFacebookPageByLanguage</a></li><li data-type='method'><a href="Page_Controller.html#getFacebookPageInfo">getFacebookPageInfo</a></li><li data-type='method'><a href="Page_Controller.html#getFacebookPageLanguage">getFacebookPageLanguage</a></li><li data-type='method'><a href="Page_Controller.html#getFacebookPageToken">getFacebookPageToken</a></li><li data-type='method'><a href="Page_Controller.html#isValidPage">isValidPage</a></li></ul></li><li><a href="User_Controller.html">User_Controller</a><ul class='methods'><li data-type='method'><a href="User_Controller.html#addUser">addUser</a></li><li data-type='method'><a href="User_Controller.html#getNewUser">getNewUser</a></li><li data-type='method'><a href="User_Controller.html#getUser">getUser</a></li><li data-type='method'><a href="User_Controller.html#getUserByName">getUserByName</a></li><li data-type='method'><a href="User_Controller.html#getUserData">getUserData</a></li><li data-type='method'><a href="User_Controller.html#getUsers">getUsers</a></li><li data-type='method'><a href="User_Controller.html#updateUser">updateUser</a></li></ul></li></ul><h3>Mixins</h3><ul><li><a href="Rivescript_Tags.html">Rivescript_Tags</a><ul class='members'><li data-type='method'><a href="Rivescript_Tags.html#attachment">attachment</a></li><li data-type='method'><a href="Rivescript_Tags.html#br">br</a></li><li data-type='method'><a href="Rivescript_Tags.html#button">button</a></li><li data-type='method'><a href="Rivescript_Tags.html#delay">delay</a></li><li data-type='method'><a href="Rivescript_Tags.html#if">if</a></li><li data-type='method'><a href="Rivescript_Tags.html#if1">if</a></li><li data-type='method'><a href="Rivescript_Tags.html#ifbreak">ifbreak</a></li><li data-type='method'><a href="Rivescript_Tags.html#next">next</a></li><li data-type='method'><a href="Rivescript_Tags.html#nrsp">nrsp</a></li><li data-type='method'><a href="Rivescript_Tags.html#quickreply">quickreply</a></li><li data-type='method'><a href="Rivescript_Tags.html#save">save</a></li><li data-type='method'><a href="Rivescript_Tags.html#script">script</a></li><li data-type='method'><a href="Rivescript_Tags.html#template">template</a></li><li data-type='method'><a href="Rivescript_Tags.html#update">update</a></li><li data-type='method'><a href="Rivescript_Tags.html#var">var</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#Bot">Bot</a></li><li><a href="global.html#BotConfig">BotConfig</a></li><li><a href="global.html#BotOptions">BotOptions</a></li><li><a href="global.html#DatabaseConfig">DatabaseConfig</a></li><li><a href="global.html#DebugConfig">DebugConfig</a></li><li><a href="global.html#DispatcherConfig">DispatcherConfig</a></li><li><a href="global.html#EntityConfig">EntityConfig</a></li><li><a href="global.html#Event">Event</a></li><li><a href="global.html#FacebookConfig">FacebookConfig</a></li><li><a href="global.html#PageConfig">PageConfig</a></li><li><a href="global.html#PageObjectConfig">PageObjectConfig</a></li><li><a href="global.html#UserResponse">UserResponse</a></li><li><a href="global.html#UserUpdateResponse">UserUpdateResponse</a></li><li><a href="global.html#WordConfig">WordConfig</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">controllers/menu.js</h1>
    
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var promise 		= require('bluebird');

var botconfig   = require('../config/botconfig');

var fbmessageutil 	= require('../utils/fbmessageutil');
var stringutil 		= require('../utils/stringutil');
var utility 		= require('../utils/utility');

exports = module.exports = function(menus)
{
	return new Menuctl(menus);
}

/**
 * @constructs Menu_Controller
 * @public
 * @param {Object} menus - Menus object with menus to be used in rivescript - {@link https://github.com/tostegroo/rivescript-nginb-js/blob/master/template-files/menus.js|template}
 * @param {Object} texts - Texts object with text and localization to be used in rivescript - {@link https://github.com/tostegroo/rivescript-nginb-js/blob/master/template-files/texts.js|template}
 */
function Menuctl(menus, texts)
{
	texts = texts || false;
	menus = menus || false;

	this.texts = texts;
	this.menus = menus;
}

/**
 * Gets the menu object by a given menu name and localization
 * @param {String} menu - The name of the menu
 * @param {String} lang - The language of the menu for multilanguage menus
 * @return {Object} A bluebird promise menu object
 */
Menuctl.prototype.getMenu = function getMenu(menu, lang)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		if(self.menus &amp;&amp; typeof(menu)=='string' &amp;&amp; self.menus.data.hasOwnProperty(menu))
		{
			var return_menu = false;
			var string_menu = JSON.stringify(self.menus.data[menu]);
			string_menu = stringutil.replacePath(string_menu, botconfig);

			if(self.texts)
			{
				for(k in self.texts)
				{
					var value = self.texts[k][lang];
					var k_string = '$'+k;

					if(value!=undefined)
					{
						if(typeof(value)=='object')
						{
							value = JSON.stringify(value);
							value = stringutil.replaceAll(value, '[', '');
							value = stringutil.replaceAll(value, ']', '');

							k_string = '"' + k_string + '"';
						}
						string_menu = stringutil.replaceAll(string_menu, k_string, value);
					}
				}
			}

			try{return_menu = JSON.parse(string_menu);}
			catch(err){console.log('menu error:', err)}

			resolve(return_menu);
		}
		else
		{
			if(self.menus.getMenu &amp;&amp; typeof(self.menus.getMenu)=='function')
				resolve(self.menus.getMenu(menu));
			else
				resolve(false);
		}
	});
}

/**
 * Gets the facebook menu object
 * @param {Object} menu - The menu object - {@link https://github.com/tostegroo/rivescript-nginb-js/blob/master/template-files/menus.js|template}
 * @param {String} sender - The facebook sender id
 * @param {String} page_id - The facebook page id
 * @param {Object} data - The data object used for comparations, if any (Eg. userdata object)
 * @param {Object} params - The params object to determine if a nutton will be used (an array of integers)
 * @return {Object} A facebook formatted menu object
 */
Menuctl.prototype.getFacebookMenu = function getFacebookMenu(menu, sender, page_id, data, params)
{
	var self = this;

	data = data || {};
	params = params || [];

	var response = {text: ''};
	if(menu!=undefined)
	{
		if(menu.type!=undefined &amp;&amp; (menu.type=='template' || menu.type=='button' || menu.type=='quick_reply'))
		{
			var menu_data = (menu.data!=undefined &amp;&amp; menu.data.length!=undefined &amp;&amp; menu.data.length>0) ? menu.data : {};

			if(menu.type=='button')
			{
				menu_data = menu_data[0];
				var title = (menu_data.hasOwnProperty('title')) ? menu_data.title : 'Menu';
				var menu_buttons = (menu_data.hasOwnProperty('buttons') &amp;&amp; menu_data.buttons.length>0) ? menu_data.buttons : [{"title":"OK", "payload":"ok"}];
				var buttons = self.getFacebookButtons(menu_buttons, sender, page_id, data, params);

				response = fbmessageutil.messageButtons(title, buttons);
			}
			else if(menu.type=='template')
			{
				var elements = [];
				for (var i = 0; i &lt; menu_data.length; i++)
				{
					var menu_item = menu_data[i];

					var menu_buttons = (menu_item.hasOwnProperty('buttons') &amp;&amp; menu_item.buttons.length>0) ? menu_item.buttons : [{"title":"OK", "payload":"ok"}];
					menu_item.buttons = self.getFacebookButtons(menu_buttons, sender, page_id, data, params);

					elements.push(fbmessageutil.genericTemplateElement(menu_item, menu_item.buttons));
				}

				response = fbmessageutil.genericTemplate(elements);
			}
			else if(menu.type=='quick_reply')
			{
				var params = {};
				menu_data = menu_data[0];

				var quick_replies = (menu_data.hasOwnProperty('quick_replies') &amp;&amp; menu_data.quick_replies.length>0) ? menu_data.quick_replies : [{"title":"OK", "payload":"ok"}];
				quick_replies = self.getFacebookButtons(quick_replies, sender, page_id, data, params);

				params.text = (menu_data.hasOwnProperty('text')) ? menu_data.text : 'menu';

				if(menu_data.hasOwnProperty('attachment'))
					params.attachment = menu_data.attachment;

				response = fbmessageutil.quickReply(params, quick_replies);
			}
		}
	}

	return response;
}

/**
 * Gets the facebook buttons object
 * @param {Object} base_buttons - The base buttons object, normaly an simplyfied version of facebook button object
 * @param {String} sender - The facebook sender id
 * @param {String} page_id - The facebook page id
 * @param {Object} data - The data object used for comparations, if any (Eg. userdata object)
 * @param {Object} params - The params object to determine if a nutton will be used (an array of integers)
 * @return {Object} An array of facebook formatted button objects
 */
Menuctl.prototype.getFacebookButtons = function getFacebookButtons(base_buttons, sender, page_id, data, params)
{
	data = data || {};
	params = params || [];
	var paramslength = (params.length!=undefined) ? params.length : 0;

	var buttons = [];
	for (var i = 0; i &lt; base_buttons.length; i++)
	{
		var button = base_buttons[i];

		if(typeof(button)=='string')
			button = {title: button, payload: "cmdr" + (i + 1)};

		var putId = false;
		var encodeId = false;
		var usebutton = true;

		if(button.hasOwnProperty('if'))
		{
			usebutton = utility.if(button.if, data);
			delete button.if;
		}
		else if(paramslength>i)
			usebutton = (params[i] == 0) ? false : true;

		if(usebutton)
		{
			if(button.hasOwnProperty('encode_id'))
			{
				encodeId = button.encode_id;
				delete button.encode_id;
			}

			if(button.hasOwnProperty('send_id'))
			{
				putId = button.send_id;
				delete button.send_id;
			}

			if(!button.hasOwnProperty('type'))
			{
				if(button.hasOwnProperty('url'))
					button.type = "web_url";
				else
					button.type = "postback";
			}
			else
			{
				if(button.type=='web_url')
					button = fbmessageutil.urlButton(button.title, button.url, button.webview_height_ratio);
				else if(button.type=='postback')
					button = fbmessageutil.postbackButton(button.title, button.payload);
				else if(button.type=='phone_number')
					button = fbmessageutil.callButton(button.title, button.payload);
				else if(button.type=='element_share')
					button = fbmessageutil.shareButton();
				else if(button.type=='payment')
					button = fbmessageutil.buyButton(button.title, button.payload, {});
			}

			if(putId &amp;&amp; sender!=undefined &amp;&amp; sender!='' &amp;&amp; button.type=='web_url')
			{
				var pre = (button.url.indexOf('?')==-1) ? '?' : '&amp;';
				var pid = page_id || '';

				if(encodeId)
					button.url += pre+'s='+ stringutil.tcEncode(sender) + '&amp;p=' + stringutil.tcEncode(pid);
				else
					button.url += pre+'s='+sender + '&amp;p=' + pid;

			}

			if(button.type=='web_url' &amp;&amp; button.url.indexOf('$')!=-1)
				button.url = stringutil.replacePath(button.url, botconfig);

			buttons.push(button);
		}
	}

	return buttons;
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Mon May 15 2017 12:10:23 GMT-0300 (E. South America Standard Time) using the Toast theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
