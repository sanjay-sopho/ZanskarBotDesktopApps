<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>index.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Attachment_Controller.html">Attachment_Controller</a><ul class='methods'><li data-type='method'><a href="Attachment_Controller.html#getAttachment">getAttachment</a></li><li data-type='method'><a href="Attachment_Controller.html#getAttachmentUrl">getAttachmentUrl</a></li></ul></li><li><a href="Bot_Controller.html">Bot_Controller</a><ul class='methods'><li data-type='method'><a href="Bot_Controller.html#clearUservars">clearUservars</a></li><li data-type='method'><a href="Bot_Controller.html#freezeUservars">freezeUservars</a></li><li data-type='method'><a href="Bot_Controller.html#getArray">getArray</a></li><li data-type='method'><a href="Bot_Controller.html#getSubstitution">getSubstitution</a></li><li data-type='method'><a href="Bot_Controller.html#getUserTopicTriggers">getUserTopicTriggers</a></li><li data-type='method'><a href="Bot_Controller.html#getUservar">getUservar</a></li><li data-type='method'><a href="Bot_Controller.html#getUservars">getUservars</a></li><li data-type='method'><a href="Bot_Controller.html#getVariable">getVariable</a></li><li data-type='method'><a href="Bot_Controller.html#initialMatch">initialMatch</a></li><li data-type='method'><a href="Bot_Controller.html#lastMatch">lastMatch</a></li><li data-type='method'><a href="Bot_Controller.html#processEvent">processEvent</a></li><li data-type='method'><a href="Bot_Controller.html#setArray">setArray</a></li><li data-type='method'><a href="Bot_Controller.html#setEntities">setEntities</a></li><li data-type='method'><a href="Bot_Controller.html#setGlobal">setGlobal</a></li><li data-type='method'><a href="Bot_Controller.html#setHandler">setHandler</a></li><li data-type='method'><a href="Bot_Controller.html#setPerson">setPerson</a></li><li data-type='method'><a href="Bot_Controller.html#setSubroutine">setSubroutine</a></li><li data-type='method'><a href="Bot_Controller.html#setSubstitution">setSubstitution</a></li><li data-type='method'><a href="Bot_Controller.html#setUservar">setUservar</a></li><li data-type='method'><a href="Bot_Controller.html#setUservars">setUservars</a></li><li data-type='method'><a href="Bot_Controller.html#setVariable">setVariable</a></li><li data-type='method'><a href="Bot_Controller.html#thawUservars">thawUservars</a></li></ul></li><li><a href="Facebook_Controller.html">Facebook_Controller</a><ul class='methods'><li data-type='method'><a href="Facebook_Controller.html#deleteMessengerProfile">deleteMessengerProfile</a></li><li data-type='method'><a href="Facebook_Controller.html#domainWhitelisting">domainWhitelisting</a></li><li data-type='method'><a href="Facebook_Controller.html#doSubscribeRequest">doSubscribeRequest</a></li><li data-type='method'><a href="Facebook_Controller.html#facebookLogin">facebookLogin</a></li><li data-type='method'><a href="Facebook_Controller.html#getFacebookMessage">getFacebookMessage</a></li><li data-type='method'><a href="Facebook_Controller.html#getFacebookTemplate">getFacebookTemplate</a></li><li data-type='method'><a href="Facebook_Controller.html#getFacebookToken">getFacebookToken</a></li><li data-type='method'><a href="Facebook_Controller.html#getFacebookUserData">getFacebookUserData</a></li><li data-type='method'><a href="Facebook_Controller.html#getFacebookUserDataByCode">getFacebookUserDataByCode</a></li><li data-type='method'><a href="Facebook_Controller.html#getMessengerProfile">getMessengerProfile</a></li><li data-type='method'><a href="Facebook_Controller.html#messengerEvent">messengerEvent</a></li><li data-type='method'><a href="Facebook_Controller.html#requestUserData">requestUserData</a></li><li data-type='method'><a href="Facebook_Controller.html#sendAction">sendAction</a></li><li data-type='method'><a href="Facebook_Controller.html#sendMessage">sendMessage</a></li><li data-type='method'><a href="Facebook_Controller.html#setGreetingText">setGreetingText</a></li><li data-type='method'><a href="Facebook_Controller.html#setMessengerProfile">setMessengerProfile</a></li><li data-type='method'><a href="Facebook_Controller.html#setPersistentMenu">setPersistentMenu</a></li><li data-type='method'><a href="Facebook_Controller.html#setStartButton">setStartButton</a></li></ul></li><li><a href="Menu_Controller.html">Menu_Controller</a><ul class='methods'><li data-type='method'><a href="Menu_Controller.html#getFacebookButtons">getFacebookButtons</a></li><li data-type='method'><a href="Menu_Controller.html#getFacebookMenu">getFacebookMenu</a></li><li data-type='method'><a href="Menu_Controller.html#getMenu">getMenu</a></li></ul></li><li><a href="NGINB.html">NGINB</a><ul class='methods'><li data-type='method'><a href="NGINB.html#addEventListener">addEventListener</a></li><li data-type='method'><a href="NGINB.html#configure">configure</a></li><li data-type='method'><a href="NGINB.html#dispatchDirectMessage">dispatchDirectMessage</a></li><li data-type='method'><a href="NGINB.html#dispatchEvent">dispatchEvent</a></li><li data-type='method'><a href="NGINB.html#getBotController">getBotController</a></li><li data-type='method'><a href="NGINB.html#getBotResponse">getBotResponse</a></li><li data-type='method'><a href="NGINB.html#getFacebookController">getFacebookController</a></li><li data-type='method'><a href="NGINB.html#getMenuController">getMenuController</a></li><li data-type='method'><a href="NGINB.html#getPageController">getPageController</a></li><li data-type='method'><a href="NGINB.html#getUserController">getUserController</a></li><li data-type='method'><a href="NGINB.html#sendMessageEvent">sendMessageEvent</a></li><li data-type='method'><a href="NGINB.html#setEntities">setEntities</a></li></ul></li><li><a href="Page_Controller.html">Page_Controller</a><ul class='methods'><li data-type='method'><a href="Page_Controller.html#getFacebookPageByLanguage">getFacebookPageByLanguage</a></li><li data-type='method'><a href="Page_Controller.html#getFacebookPageInfo">getFacebookPageInfo</a></li><li data-type='method'><a href="Page_Controller.html#getFacebookPageLanguage">getFacebookPageLanguage</a></li><li data-type='method'><a href="Page_Controller.html#getFacebookPageToken">getFacebookPageToken</a></li><li data-type='method'><a href="Page_Controller.html#isValidPage">isValidPage</a></li></ul></li><li><a href="User_Controller.html">User_Controller</a><ul class='methods'><li data-type='method'><a href="User_Controller.html#addUser">addUser</a></li><li data-type='method'><a href="User_Controller.html#getNewUser">getNewUser</a></li><li data-type='method'><a href="User_Controller.html#getUser">getUser</a></li><li data-type='method'><a href="User_Controller.html#getUserByName">getUserByName</a></li><li data-type='method'><a href="User_Controller.html#getUserData">getUserData</a></li><li data-type='method'><a href="User_Controller.html#getUsers">getUsers</a></li><li data-type='method'><a href="User_Controller.html#updateUser">updateUser</a></li></ul></li></ul><h3>Mixins</h3><ul><li><a href="Rivescript_Tags.html">Rivescript_Tags</a><ul class='members'><li data-type='method'><a href="Rivescript_Tags.html#attachment">attachment</a></li><li data-type='method'><a href="Rivescript_Tags.html#br">br</a></li><li data-type='method'><a href="Rivescript_Tags.html#button">button</a></li><li data-type='method'><a href="Rivescript_Tags.html#delay">delay</a></li><li data-type='method'><a href="Rivescript_Tags.html#if">if</a></li><li data-type='method'><a href="Rivescript_Tags.html#if1">if</a></li><li data-type='method'><a href="Rivescript_Tags.html#ifbreak">ifbreak</a></li><li data-type='method'><a href="Rivescript_Tags.html#next">next</a></li><li data-type='method'><a href="Rivescript_Tags.html#nrsp">nrsp</a></li><li data-type='method'><a href="Rivescript_Tags.html#quickreply">quickreply</a></li><li data-type='method'><a href="Rivescript_Tags.html#save">save</a></li><li data-type='method'><a href="Rivescript_Tags.html#script">script</a></li><li data-type='method'><a href="Rivescript_Tags.html#template">template</a></li><li data-type='method'><a href="Rivescript_Tags.html#update">update</a></li><li data-type='method'><a href="Rivescript_Tags.html#var">var</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#Bot">Bot</a></li><li><a href="global.html#BotConfig">BotConfig</a></li><li><a href="global.html#BotOptions">BotOptions</a></li><li><a href="global.html#DatabaseConfig">DatabaseConfig</a></li><li><a href="global.html#DebugConfig">DebugConfig</a></li><li><a href="global.html#DispatcherConfig">DispatcherConfig</a></li><li><a href="global.html#EntityConfig">EntityConfig</a></li><li><a href="global.html#Event">Event</a></li><li><a href="global.html#FacebookConfig">FacebookConfig</a></li><li><a href="global.html#PageConfig">PageConfig</a></li><li><a href="global.html#PageObjectConfig">PageObjectConfig</a></li><li><a href="global.html#UserResponse">UserResponse</a></li><li><a href="global.html#UserUpdateResponse">UserUpdateResponse</a></li><li><a href="global.html#WordConfig">WordConfig</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">index.js</h1>
    
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * NGINB - A Rivescript-Node engine to make bots interaction with Facebook Messenger and Databases easier
 * @namespace NGINB
 * @version 0.1.5
 * @author Fabio Toste &lt;tostegroo@gmail.com>
 */

var promise 	    = require('bluebird');
var cron            = require('node-cron');

var humanization    = require('./config/humanization');
var botconfig       = require('./config/botconfig');
var stringutil      = require('./utils/stringutil');
var utility         = require('./utils/utility');
var debugutil       = require('./utils/debugutil');

var messenger       = false;
var pagectl         = false;
var userctl         = false;
var facebookctl     = false;
var botctl          = false;
var menuctl         = false;

exports = module.exports = createApplication;

/**
 * @constructs NGINB
 * @public
 * @param  {BotOptions} options - Bot options object
 * @return {Object} A bot instance
 */
function createApplication(options)
{
    return new NGINB(options);
}

/**
 * @constructor
 * @class
 * @param  {BotOptions} options - Bot options object
 * @return {Object} A bot instance
 */
function NGINB(options)
{
    var self = this;
    options = options || {};
    options.instances = options.instances || {};

    this.configure(options);

    var scriptctl = require('./controllers/script')(options.scripts);
    var attachmentclt = require('./controllers/attachment')(options.attachments);
    menuctl = require('./controllers/menu')(options.menus, options.texts);
    var updatectl = require('./controllers/update')();

    pagectl = require('./controllers/page')();
    facebookctl = require('./controllers/facebook')(pagectl, attachmentclt, menuctl);
    userctl = require('./controllers/user')(facebookctl, options.custom_user);
    botctl = require('./controllers/bot')(options.instances);
    messenger = require('./controllers/message')(userctl, botctl, scriptctl, updatectl, facebookctl);

    self.utils = {};
    for (var k in utility)
        self.utils[k] = utility[k];

    for (var k in stringutil)
        self.utils[k] = stringutil[k];

    if(options.dispatcher &amp;&amp; options.dispatcher.time &amp;&amp; options.dispatcher.function)
    {
        cron.schedule(options.dispatcher.time, function()
    	{
    		options.dispatcher.function();
    	});
    }

    return this;
}

/**
 * Configures the bot instance, if you need to change something after the instance is created
 * @public
 * @param  {BotOptions} options - Bot options object
 */
NGINB.prototype.configure = function configure(options)
{
    setConfigs(options, botconfig);

    this.config = botconfig;

    if(options.humanization)
    {
        if(options.humanization.words)
            humanization.words = options.humanization.words;

        if(options.humanization.errorwords)
            humanization.errorwords = options.humanization.errorwords;

        if(options.humanization.abbreviations)
            humanization.abbreviations = options.humanization.abbreviations;
    }

    if(options.debug)
    {
        debugutil.debug_enabled = true;
        for (var k in options.debug)
        {
            if(debugutil.hasOwnProperty(k))
                debugutil[k] = options.debug[k];
        }
    }

    if(options.accept_commands_from_user)
        debugutil.accept_commands_from_user = options.accept_commands_from_user;
}

/**
 * Gets the menu controller used in this instance
 * @return {Menu_Controller} A menu controller
 */
NGINB.prototype.getMenuController = function getPageController()
{
    return menuctl;
}

/**
 * Gets the page controller used in this instance
 * @return {Page_Controller} A page controller
 */
NGINB.prototype.getPageController = function getPageController()
{
    return pagectl;
}

/**
 * Gets the facebook controller used in this instance
 * @return {Facebook_Controller} A facebook controller
 *
 */
NGINB.prototype.getFacebookController = function getFacebookController()
{
    return facebookctl;
}

/**
 * Gets the bot controller used in this instance
 * @return {Bot_Controller} A bot controller
 */
NGINB.prototype.getBotController = function getBotController()
{
    return botctl;
}

/**
 * Gets the user controller used in this instance
 * @return {User_Controller} An user controller
 */
NGINB.prototype.getUserController = function getUserController()
{
    return userctl;
}

/**
 * Adds an event listener to the bot messenger controller
 * @public
 * @param {String} listener - A string with one of the listeners:&lt;br>
                              &lt;b>FinishFacebookMessageDispatch&lt;/b>&lt;br>
                              &lt;b>FinishAllFacebookMessageDispatch&lt;/b>&lt;br>
                              &lt;b>FinishMessageDispatch&lt;/b>&lt;br>
                              &lt;b>FinishAllMessageDispatch&lt;/b>&lt;br>
                              &lt;b>HandleCustomMessageReplyItems&lt;/b>
 * @param {Function} callback - The function to be called on event
 */
NGINB.prototype.addEventListener = function(listener, callback)
{
    if(messenger &amp;&amp; messenger['on'+listener]!=undefined)
        messenger['on'+listener] = callback;
}

/**
 * Sends a message to messenger
 * @param {Event} event - An event object
 * @param {Object} user_data - If you have a previous loaded userdata, you can send it here
 * @return {Object} A bluebird promisse response
 */
NGINB.prototype.sendMessageEvent = function sendMessageEvent(event, user_data)
{
    return new promise(function(resolve, reject)
	{
        messenger.processMessengeEvent(event, user_data)
        .then(function(response)
        {
            resolve(response);
        });
    });
}

/**
 * Dispatch an event, can dispatch diretctly or using a bot
 * @param {Event} event - An event object
 * @return {Object} A bluebird promisse response
 */
NGINB.prototype.dispatchEvent = function dispatchEvent(event)
{
    return new promise(function(resolve, reject)
	{
        messenger.dispatchEvent(event)
        .then(function(response)
        {
            resolve(response);
        });
    });
}

/**
 * Dispatch a message without pass to the bot's brain
 * @param {Object} message - An object (The "text" key is required)
 * @param {Event} event - An event object
 * @return {Object} A bluebird promisse response
 */
NGINB.prototype.dispatchDirectMessage = function dispatchDirectMessage(message, event)
{
    return new promise(function(resolve, reject)
	{
        messenger.dispatchDirectMessage(message, event)
        resolve({status:1, message:'direct message dispactched', data:message});
    });
}

/**
 * Sends a message diretctly to the bot
 * @param {Event} event - An Event object sent by facebook controller
 * @return {Object} A bluebird promisse response
 */
NGINB.prototype.getBotResponse = function getBotResponse(event)
{
    return new promise(function(resolve, reject)
	{
        botctl.processEvent(event)
        .then(function(response)
        {
            resolve(response);
        });
    });
}

/**
 * Sets the entities as subs to be used by rivescript
 * @param {EntityConfig[]} entities - An object to be transformed to subs in rivescript - see: https://github.com/tostegroo/rivescript-nginb-js/blob/master/template-files/entities.js
 * @param {String} lang - The brain language to be used to fill the subs
 * @return {Object} A bluebird promisse response
 */
NGINB.prototype.setEntities = function setEntities(entities, lang)
{
    return new promise(function(resolve, reject)
	{
        botctl.setEntities(entities, lang)
        .then(function(response)
        {
            resolve(response);
        });
    });
}

/**
 * A private function to set the bot default config file by a given config sent
 * @private
 * @param  {String} new_config - The config sent
 * @param  {String} default_config - The default config object
 */
function setConfigs(new_config, default_config)
{
    for (var k in new_config)
    {
        if (new_config.hasOwnProperty(k) &amp;&amp; default_config.hasOwnProperty(k))
        {
            if(typeof(default_config[k])=='object' &amp;&amp; typeof(new_config[k])=='object' &amp;&amp; k!='pages')
            {
                setConfigs(new_config[k], default_config[k]);
            }
            else
            {
                default_config[k] = new_config[k];
            }

        }
    }
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Mon May 15 2017 12:10:23 GMT-0300 (E. South America Standard Time) using the Toast theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
