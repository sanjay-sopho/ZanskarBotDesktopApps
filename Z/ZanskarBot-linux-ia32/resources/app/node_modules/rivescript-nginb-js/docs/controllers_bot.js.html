<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>controllers/bot.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Attachment_Controller.html">Attachment_Controller</a><ul class='methods'><li data-type='method'><a href="Attachment_Controller.html#getAttachment">getAttachment</a></li><li data-type='method'><a href="Attachment_Controller.html#getAttachmentUrl">getAttachmentUrl</a></li></ul></li><li><a href="Bot_Controller.html">Bot_Controller</a><ul class='methods'><li data-type='method'><a href="Bot_Controller.html#clearUservars">clearUservars</a></li><li data-type='method'><a href="Bot_Controller.html#freezeUservars">freezeUservars</a></li><li data-type='method'><a href="Bot_Controller.html#getArray">getArray</a></li><li data-type='method'><a href="Bot_Controller.html#getSubstitution">getSubstitution</a></li><li data-type='method'><a href="Bot_Controller.html#getUserTopicTriggers">getUserTopicTriggers</a></li><li data-type='method'><a href="Bot_Controller.html#getUservar">getUservar</a></li><li data-type='method'><a href="Bot_Controller.html#getUservars">getUservars</a></li><li data-type='method'><a href="Bot_Controller.html#getVariable">getVariable</a></li><li data-type='method'><a href="Bot_Controller.html#initialMatch">initialMatch</a></li><li data-type='method'><a href="Bot_Controller.html#lastMatch">lastMatch</a></li><li data-type='method'><a href="Bot_Controller.html#processEvent">processEvent</a></li><li data-type='method'><a href="Bot_Controller.html#setArray">setArray</a></li><li data-type='method'><a href="Bot_Controller.html#setEntities">setEntities</a></li><li data-type='method'><a href="Bot_Controller.html#setGlobal">setGlobal</a></li><li data-type='method'><a href="Bot_Controller.html#setHandler">setHandler</a></li><li data-type='method'><a href="Bot_Controller.html#setPerson">setPerson</a></li><li data-type='method'><a href="Bot_Controller.html#setSubroutine">setSubroutine</a></li><li data-type='method'><a href="Bot_Controller.html#setSubstitution">setSubstitution</a></li><li data-type='method'><a href="Bot_Controller.html#setUservar">setUservar</a></li><li data-type='method'><a href="Bot_Controller.html#setUservars">setUservars</a></li><li data-type='method'><a href="Bot_Controller.html#setVariable">setVariable</a></li><li data-type='method'><a href="Bot_Controller.html#thawUservars">thawUservars</a></li></ul></li><li><a href="Facebook_Controller.html">Facebook_Controller</a><ul class='methods'><li data-type='method'><a href="Facebook_Controller.html#deleteMessengerProfile">deleteMessengerProfile</a></li><li data-type='method'><a href="Facebook_Controller.html#domainWhitelisting">domainWhitelisting</a></li><li data-type='method'><a href="Facebook_Controller.html#doSubscribeRequest">doSubscribeRequest</a></li><li data-type='method'><a href="Facebook_Controller.html#facebookLogin">facebookLogin</a></li><li data-type='method'><a href="Facebook_Controller.html#getFacebookMessage">getFacebookMessage</a></li><li data-type='method'><a href="Facebook_Controller.html#getFacebookTemplate">getFacebookTemplate</a></li><li data-type='method'><a href="Facebook_Controller.html#getFacebookToken">getFacebookToken</a></li><li data-type='method'><a href="Facebook_Controller.html#getFacebookUserData">getFacebookUserData</a></li><li data-type='method'><a href="Facebook_Controller.html#getFacebookUserDataByCode">getFacebookUserDataByCode</a></li><li data-type='method'><a href="Facebook_Controller.html#getMessengerProfile">getMessengerProfile</a></li><li data-type='method'><a href="Facebook_Controller.html#messengerEvent">messengerEvent</a></li><li data-type='method'><a href="Facebook_Controller.html#requestUserData">requestUserData</a></li><li data-type='method'><a href="Facebook_Controller.html#sendAction">sendAction</a></li><li data-type='method'><a href="Facebook_Controller.html#sendMessage">sendMessage</a></li><li data-type='method'><a href="Facebook_Controller.html#setGreetingText">setGreetingText</a></li><li data-type='method'><a href="Facebook_Controller.html#setMessengerProfile">setMessengerProfile</a></li><li data-type='method'><a href="Facebook_Controller.html#setPersistentMenu">setPersistentMenu</a></li><li data-type='method'><a href="Facebook_Controller.html#setStartButton">setStartButton</a></li></ul></li><li><a href="Menu_Controller.html">Menu_Controller</a><ul class='methods'><li data-type='method'><a href="Menu_Controller.html#getFacebookButtons">getFacebookButtons</a></li><li data-type='method'><a href="Menu_Controller.html#getFacebookMenu">getFacebookMenu</a></li><li data-type='method'><a href="Menu_Controller.html#getMenu">getMenu</a></li></ul></li><li><a href="NGINB.html">NGINB</a><ul class='methods'><li data-type='method'><a href="NGINB.html#addEventListener">addEventListener</a></li><li data-type='method'><a href="NGINB.html#configure">configure</a></li><li data-type='method'><a href="NGINB.html#dispatchDirectMessage">dispatchDirectMessage</a></li><li data-type='method'><a href="NGINB.html#dispatchEvent">dispatchEvent</a></li><li data-type='method'><a href="NGINB.html#getBotController">getBotController</a></li><li data-type='method'><a href="NGINB.html#getBotResponse">getBotResponse</a></li><li data-type='method'><a href="NGINB.html#getFacebookController">getFacebookController</a></li><li data-type='method'><a href="NGINB.html#getMenuController">getMenuController</a></li><li data-type='method'><a href="NGINB.html#getPageController">getPageController</a></li><li data-type='method'><a href="NGINB.html#getUserController">getUserController</a></li><li data-type='method'><a href="NGINB.html#sendMessageEvent">sendMessageEvent</a></li><li data-type='method'><a href="NGINB.html#setEntities">setEntities</a></li></ul></li><li><a href="Page_Controller.html">Page_Controller</a><ul class='methods'><li data-type='method'><a href="Page_Controller.html#getFacebookPageByLanguage">getFacebookPageByLanguage</a></li><li data-type='method'><a href="Page_Controller.html#getFacebookPageInfo">getFacebookPageInfo</a></li><li data-type='method'><a href="Page_Controller.html#getFacebookPageLanguage">getFacebookPageLanguage</a></li><li data-type='method'><a href="Page_Controller.html#getFacebookPageToken">getFacebookPageToken</a></li><li data-type='method'><a href="Page_Controller.html#isValidPage">isValidPage</a></li></ul></li><li><a href="User_Controller.html">User_Controller</a><ul class='methods'><li data-type='method'><a href="User_Controller.html#addUser">addUser</a></li><li data-type='method'><a href="User_Controller.html#getNewUser">getNewUser</a></li><li data-type='method'><a href="User_Controller.html#getUser">getUser</a></li><li data-type='method'><a href="User_Controller.html#getUserByName">getUserByName</a></li><li data-type='method'><a href="User_Controller.html#getUserData">getUserData</a></li><li data-type='method'><a href="User_Controller.html#getUsers">getUsers</a></li><li data-type='method'><a href="User_Controller.html#updateUser">updateUser</a></li></ul></li></ul><h3>Mixins</h3><ul><li><a href="Rivescript_Tags.html">Rivescript_Tags</a><ul class='members'><li data-type='method'><a href="Rivescript_Tags.html#attachment">attachment</a></li><li data-type='method'><a href="Rivescript_Tags.html#br">br</a></li><li data-type='method'><a href="Rivescript_Tags.html#button">button</a></li><li data-type='method'><a href="Rivescript_Tags.html#delay">delay</a></li><li data-type='method'><a href="Rivescript_Tags.html#if">if</a></li><li data-type='method'><a href="Rivescript_Tags.html#if1">if</a></li><li data-type='method'><a href="Rivescript_Tags.html#ifbreak">ifbreak</a></li><li data-type='method'><a href="Rivescript_Tags.html#next">next</a></li><li data-type='method'><a href="Rivescript_Tags.html#nrsp">nrsp</a></li><li data-type='method'><a href="Rivescript_Tags.html#quickreply">quickreply</a></li><li data-type='method'><a href="Rivescript_Tags.html#save">save</a></li><li data-type='method'><a href="Rivescript_Tags.html#script">script</a></li><li data-type='method'><a href="Rivescript_Tags.html#template">template</a></li><li data-type='method'><a href="Rivescript_Tags.html#update">update</a></li><li data-type='method'><a href="Rivescript_Tags.html#var">var</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#Bot">Bot</a></li><li><a href="global.html#BotConfig">BotConfig</a></li><li><a href="global.html#BotOptions">BotOptions</a></li><li><a href="global.html#DatabaseConfig">DatabaseConfig</a></li><li><a href="global.html#DebugConfig">DebugConfig</a></li><li><a href="global.html#DispatcherConfig">DispatcherConfig</a></li><li><a href="global.html#EntityConfig">EntityConfig</a></li><li><a href="global.html#Event">Event</a></li><li><a href="global.html#FacebookConfig">FacebookConfig</a></li><li><a href="global.html#PageConfig">PageConfig</a></li><li><a href="global.html#PageObjectConfig">PageObjectConfig</a></li><li><a href="global.html#UserResponse">UserResponse</a></li><li><a href="global.html#UserUpdateResponse">UserUpdateResponse</a></li><li><a href="global.html#WordConfig">WordConfig</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">controllers/bot.js</h1>
    
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var promise 	= require('bluebird');
var path        = require('path');
var rivescript  = require("rivescript");

var botconfig   = require('../config/botconfig').botconfig;

var botutil 	= require('../utils/botutil');
var stringutil 	= require('../utils/stringutil');
var debugutil 	= require('../utils/debugutil');

exports = module.exports = function(instances)
{
	return new Botctl(instances);
}

/**
 * @constructs Bot_Controller
 * @public
 * @param {Bot[]} instances - An array with bot instances config
 */
function Botctl(instances)
{
    this.bot = {};

    if(instances &amp;&amp; instances.length!=undefined)
    {
        for (var i = 0; i &lt; instances.length; i++)
        {
            var bot = instances[i];
            bot.language = bot.language || 'en';
            bot.config = bot.config || {};
            bot.path = bot.path || '';
            bot.variables = bot.variables || {};

            this.bot[bot.language] = {};

            this.bot[bot.language].loaded = false;
            this.bot[bot.language].entities = [];
            this.bot[bot.language].variables = bot.variables;
            this.bot[bot.language].brain = new rivescript(bot.config);

			if(bot.unicodePunctuation)
				this.bot[bot.language].brain.unicodePunctuation = bot.unicodePunctuation;

            this.bot[bot.language].brain.loadDirectory(bot.path, success_handler.bind(null, bot.language, this), error_handler.bind(null, bot.language));
        }
    }
}

/**
 * Sets a rivescript array to be used by the brain
 * @param {String} name - The name of the key of array
 * @param {Array} value - The array of values
 * @param {String} lang - The language of the bot
 * @return {Array} The array
 */
Botctl.prototype.setArray = function setArray(name, value, lang)
{
    if (value === void 0)
      return delete this.bot[lang].brain._array[name];
    else
      return this.bot[lang].brain._array[name] = value;
}

/**
 * Sets a rivescript global to be used by the brain
 * @param {String} name - The name of the key of global
 * @param {Array} value - The array of values
 * @param {String} lang - The language of the bot
 * @return {Object} The global
 */
Botctl.prototype.setGlobal = function setGlobal(name, value, lang)
{
    return this.bot[lang].brain.setGlobal(name, value);
}

/**
 * Sets a rivescript variable to be used by the brain
 * @param {String} name - The name of the key of variable
 * @param {Array} value - The array of values
 * @param {String} lang - The language of the bot
 * @return {Object} The variable
 */
Botctl.prototype.setVariable = function setVariable(name, value, lang)
{
    return this.bot[lang].brain.setVariable(name, value);
}

/**
 * Sets a rivescript user variable to be used by the brain
 * @param {String} user - The id of the user
 * @param {String} name - The name of the key of variable
 * @param {Array} value - The array of values
 * @param {String} lang - The language of the bot
 * @return {Object} The user variable
 */
Botctl.prototype.setUservar = function setUservar(user, name, value, lang)
{
    return this.bot[lang].brain.setUservar(user, name, value);
}

/**
 * Sets a object with rivescript user variables to be used by the brain
 * @param {String} user - The id of the user
 * @param {Object} data - A data object with pairs of key/values
 * @param {String} lang - The language of the bot
 * @return {Object} The user variables object
 */
Botctl.prototype.setUservars = function setUservars(user, data, lang)
{
    return this.bot[lang].brain.setUservars(user, data);
}

/**
 * Sets a rivescript subroutine to be used by the brain
 * @param {String} user - The id of the user
 * @param {Object} code - The subroutine code
 * @param {String} lang - The language of the bot
 * @return {Object} The subroutine
 */
Botctl.prototype.setSubroutine = function setSubroutine(name, code, lang)
{
    return this.bot[lang].brain.setSubroutine(name, code);
}

/**
 * Sets a rivescript handler to be used by the brain
 * @param {String} language_name - The name of language used
 * @param {Object} obj - A object to be used
 * @param {String} lang - The language of the bot
 * @return {Object} The handler
 */
Botctl.prototype.setHandler = function setHandler(language_name, obj, lang)
{
    return this.bot[lang].brain.setHandler(language_name, obj);
}

/**
 * Sets a rivescript substitution to be used by the brain
 * @param {String} name - The name of the substitution
 * @param {Object} value - The value of the substitution
 * @param {String} lang - The language of the bot
 * @return {Object} The substitution
 */
Botctl.prototype.setSubstitution = function setSubstitution(name, value, lang)
{
    return this.bot[lang].brain.setSubstitution(name, value);
}

/**
 * Sets a rivescript person to be used by the brain
 * @param {String} name - The name of the person
 * @param {Object} value - The value of the person
 * @param {String} lang - The language of the bot
 * @return {Object} The person
 */
Botctl.prototype.setPerson = function setPerson(name, value, lang)
{
    return this.bot[lang].brain.setPerson(name, value);
}

/**
 * Gets a rivescript array object
 * @param {String} lang - The language of the bot
 * @return {Array} The array object
 */
Botctl.prototype.getArray = function getArray(lang)
{
    return this.bot[lang].brain._array;
}

/**
 * Gets a rivescript subtitution object
 * @param {String} lang - The language of the bot
 * @return {Array} The subtitution object
 */
Botctl.prototype.getSubstitution = function getSubstitution(lang)
{
    return this.bot[lang].brain._sub;
}

/**
 * Gets a rivescript user last match
 * @param {String} user - The id of the user
 * @param {String} lang - The language of the bot
 * @return {Array} The rivescript user last match
 */
Botctl.prototype.lastMatch = function lastMatch(user, lang)
{
    return this.bot[lang].brain.lastMatch(user);
}

/**
 * Gets a rivescript user initial match
 * @param {String} user - The id of the user
 * @param {String} lang - The language of the bot
 * @return {Array} The rivescript user initial match
 */
Botctl.prototype.initialMatch = function initialMatch(user, lang)
{
    return this.bot[lang].brain.initialMatch(user);
}

/**
 * Gets a rivescript user topic triggers
 * @param {String} user - The id of the user
 * @param {String} lang - The language of the bot
 * @return {Array} The rivescript user initial match
 */
Botctl.prototype.getUserTopicTriggers = function getUserTopicTriggers(user, lang)
{
    return this.bot[lang].brain.getUserTopicTriggers(user);
}

/**
 * Gets a rivescript variable by a given name
 * @param {String} user - The id of the user
 * @param {String} name - The name of the substitution
 * @param {String} lang - The language of the bot
 * @return {Array} The rivescript variable
 */
Botctl.prototype.getVariable = function getVariable(user, name, lang)
{
    return this.bot[lang].brain.getVariable(user, name);
}

/**
 * Gets a rivescript user variable by a given name
 * @param {String} user - The id of the user
 * @param {String} name - The name of the substitution
 * @param {String} lang - The language of the bot
 * @return {Array} The rivescript user variable
 */
Botctl.prototype.getUservar = function getUservar(user, name, lang)
{
    return this.bot[lang].brain.getUservar(user, name);
}

/**
 * Gets a rivescript user variables object
 * @param {String} user - The id of the user
 * @param {String} lang - The language of the bot
 * @return {Array} The rivescript user variables object
 */
Botctl.prototype.getUservars = function getUservars(user, lang)
{
    return this.bot[lang].brain.getUservars(user);
}

/**
 * Clears the rivescript user variables object
 * @param {String} user - The id of the user
 * @param {String} lang - The language of the bot
 * @return {Array} The rivescript user variables object
 */
Botctl.prototype.clearUservars = function clearUservars(user, lang)
{
    return this.bot[lang].brain.clearUservars(user);
}

/**
 * Freezes the rivescript user variables object
 * @param {String} user - The id of the user
 * @param {String} lang - The language of the bot
 * @return {Array} The rivescript user variables object
 */
Botctl.prototype.freezeUservars = function freezeUservars(user, lang)
{
    return this.bot[lang].brain.freezeUservars(user);
}

/**
 * Thaws the rivescript user variables object
 * @param {String} user - The id of the user
 * @param {String} lang - The language of the bot
 * @return {Array} The rivescript user variables object
 */
Botctl.prototype.thawUservars = function thawUservars(user, lang)
{
    return this.bot[lang].brain.thawUservars(user);
}

/**
 * Process bot event and sends to rivescript
 * @param {Event} event - A NGINB event object
 * @return {Object} A bluebird promise bot response object
 */
Botctl.prototype.processEvent = function processEvent(event)
{
    var self = this;
	return new promise(function(resolve, reject)
	{
		if(!stringutil.isEmail(event.text))
			event.text = stringutil.replaceAll(event.text, '.', '');

		self.bot[event.lang].brain.replyAsync(event.sender, event.text)
        .then(function(response)
        {
            var reply = botutil.getVariablesObjectFromString(response, event.userdata);
            resolve ({reply:reply, event:event});
        })
        .catch(function(error)
        {
            console.log(error);
        });
	});
}

/**
 * Process entities and configure to use in rivescript
 * @param {EntityConfig[]} entities - An array of entities objects
 * @param {String} lang - The language of the bot to set entities to
 * @return {Boolean}  A bluebird promise with true or false
 */
Botctl.prototype.setEntities = function setEntities(entities, lang)
{
    var self = this;
    return new promise(function(resolve, reject)
	{
        entities = entities || [];
        lang = lang || 'en';

		if(self.bot[lang])
		{
	        if(self.bot[lang].loaded)
	        {
	            processEntities(entities, lang)
	            .then(function(response)
	            {
	                resolve(response);
	            });
	        }
	        else
	            self.bot[lang].entities = entities;
		}
    });
}

/**
 * Success handler for load rivescript brain instances
 * @private
 * @param {String} lang - The language of the bot
 * @param {Bot_Controller} self - This instance of bot controller
 */
function success_handler (lang, self)
{
    self.bot[lang].brain.sortReplies();
    self.bot[lang].loaded = true;

    if(self.bot[lang].variables &amp;&amp; self.bot[lang].variables.entities)
        processEntities(self,self.bot[lang].variables.entities, lang);

    if(self.bot[lang].entities.length>0)
    {
        processEntities(self, bot[lang].entities, lang);
        self.bot[lang].entities = [];
    }
}

/**
 * Error handler for load rivescript brain instances
 * @private
 * @param {String} lang - The language of the bot
 * @param {String} err - The error sent by rivescript loader
 */
function error_handler (lang, err)
{
	console.log("Error loading brains " + lang + ": " + err + "\n");
}

/**
 * A function to process the entities
 * @private
 * @param {Bot_Controller} self - This instance of bot controller
 * @param {EntityConfig[]} entities - The entities array object
 * @param {String} lang - The language of the bot
 */
function processEntities(self, entities, lang)
{
    return new promise(function(resolve, reject)
	{
        var flatentities = JSON.stringify(entities);
        var flatbotarray = JSON.stringify(self.getArray(lang));
        var flatbotsubs = JSON.stringify(self.getSubstitution(lang));

        flatentities += flatbotarray + flatbotsubs;

        for (var i = 0; i &lt; entities.length; i++)
        {
            var entity = entities[i];
            if(entity.hasOwnProperty('name') &amp;&amp; entity.hasOwnProperty('entries'))
            {
                var array = [];
                for (var j = 0; j &lt; entity.entries.length; j++)
                {
                    var entry = entity.entries[j];
                    var prefix = entry.hasOwnProperty('prefix') ? entry.prefix + ' ' : '';
                    var vlr = prefix + entry.value;
                    array.push(vlr);

                    if(entry.hasOwnProperty('synonyms'))
                    {
                        for (var s = 0; s &lt; entry.synonyms.length; s++)
                        {
                            var sub = entry.synonyms[s];

                            if(sub!=vlr)
                            {
                                self.setSubstitution(sub, vlr, lang);

                                if(botconfig.humanize_subs)
                                {
                                    for (var c = 0; c &lt; sub.length; c++)
                                    {
                                        var newword = botutil.dropChar(sub, c);

                                        if(flatentities.indexOf('"'+newword+'"')==-1)
                                            self.setSubstitution(newword, vlr, lang);

                                        newword = botutil.switchChar(sub, c);
                                        if(flatentities.indexOf('"'+newword+'"')==-1)
                                            self.setSubstitution(newword, vlr, lang);

                                        //botutil.addTypo(sub, c); will add too much subs
                                    }
                                }
                            }
                        }
                    }
                }

                self.setArray(entity.name, array, lang);
            }
        }
        resolve(true);
    });
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Mon May 15 2017 12:10:23 GMT-0300 (E. South America Standard Time) using the Toast theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
